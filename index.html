<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 ê´‘ëª…ë¶ê³  ë°°ë“œë¯¼í„´ í´ëŸ½ (ì‹¤ì‹œê°„)</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ì™„ë²½ ìœ ì§€ */
        body { font-family: 'Pretendard', 'Malgun Gothic', sans-serif; max-width: 1200px; margin: 0 auto; text-align: center; color: #333; background-color: #f0f2f5; padding: 15px; }
        header { background: linear-gradient(135deg, #2c3e50, #4ca1af); color: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; }
        header h1 { margin: 0; font-size: 28px; display: inline-block; }
        .settings-btn { background: rgba(255,255,255,0.2); border: none; color: white; font-size: 20px; padding: 5px 10px; border-radius: 8px; cursor: pointer; vertical-align: middle; margin-left: 10px; }
        section { background: #fff; margin-bottom: 25px; padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); text-align: left; }
        .block-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #ecf0f1; padding-bottom: 15px; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .block-title { font-size: 22px; font-weight: bold; color: #2c3e50; border-left: 5px solid #3498db; padding-left: 15px; }
        button { cursor: pointer; border: none; border-radius: 8px; font-weight: bold; transition: 0.2s; touch-action: manipulation; }
        .btn-small { padding: 8px 12px; font-size: 13px; background: #95a5a6; color: white; }
        .btn-green { background-color: #27ae60; color: white; padding: 12px 20px; font-size: 16px; }
        .btn-blue { background-color: #3498db; color: white; padding: 15px 30px; font-size: 18px; width: 100%; }
        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 600px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; }
        th { background-color: #f8f9fa; }
        .queue-container { display: flex; overflow-x: auto; gap: 15px; padding-bottom: 15px; }
        .queue-box { min-width: 180px; flex: 0 0 auto; border: 1px solid #dfe6e9; border-radius: 10px; background: #fff; }
        .queue-header { background-color: #636e72; color: white; padding: 10px; font-weight: bold; text-align: center; }
        .queue-body { padding: 10px; }
        .queue-body input { width: 100%; margin: 5px 0; padding: 8px; text-align: center; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .court-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .court-box { border: 2px solid #3498db; border-radius: 15px; background: #fff; overflow: hidden; display: flex; flex-direction: column; }
        .court-header { background: #3498db; color: white; padding: 10px; font-weight: bold; text-align: center; }
        .court-body { height: 120px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 15px; font-size: 16px; font-weight: bold; }
        .court-waiting { background-color: #f8f9fa; color: #bdc3c7; }
        .btn-finish { background-color: #e74c3c; color: white; padding: 12px; font-size: 15px; border-radius: 0; width: 100%; }
        @keyframes blink { 0% { background-color: #fff; } 50% { background-color: #fff176; } 100% { background-color: #fff; } }
        .blinking { animation: blink 0.5s linear 6; }

        /* íŒì—… ìŠ¤íƒ€ì¼ */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow-y: auto; }
        .modal-content { background: #fff; margin: 50px auto; padding: 25px; width: 90%; max-width: 600px; border-radius: 15px; }
        .modal-header { font-size: 20px; font-weight: bold; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; display: flex; justify-content: space-between; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .member-list-edit { width: 100%; max-height: 300px; overflow-y: auto; margin-bottom: 15px; }
    </style>
</head>
<body>

    <header>
        <h1 id="site-title">ğŸ¸ 2026 ê´‘ëª…ë¶ê³  ë°°ë“œë¯¼í„´</h1>
        <button class="settings-btn" onclick="openSettings()">âš™ï¸</button>
    </header>

    <section id="member-section">
        <div class="block-header">
            <span class="block-title">ğŸ“‚ íšŒì› ëª…ë‹¨ (ì‹¤ì‹œê°„ ì—°ë™)</span>
            <div style="display: flex; gap: 8px; align-items: center;">
                <button class="btn-small" onclick="toggleMemberView()">ì ‘ê¸°/í´ê¸°</button>
                <input type="file" id="csvFileInput" accept=".csv" style="display:none;">
                <button class="btn-green" style="padding: 8px 12px; font-size: 13px;" onclick="document.getElementById('csvFileInput').click()">íŒŒì¼ í•©ì¹˜ê¸°(CSV)</button>
                <button class="btn-green" style="padding: 8px 12px; font-size: 13px; background-color: #f39c12;" onclick="exportToCSV()">ë‚´ë³´ë‚´ê¸°</button>
                <button class="btn-green" style="padding: 8px 12px; font-size: 13px; background-color: #3498db;" onclick="openMemberManager()">ìˆ˜ì •/ì¶”ê°€</button>
                <button class="btn-small" style="background-color: #e74c3c;" onclick="resetData()">ì„œë²„ ì´ˆê¸°í™”</button>
            </div>
        </div>
        <div id="member-content">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr><th>ì´ë¦„</th><th>ì„±ë³„</th><th>ê¸‰ìˆ˜</th><th>ìŠ¹</th><th>íŒ¨</th><th>ê¸°íƒ€</th></tr>
                    </thead>
                    <tbody id="memberTableBody">
                        <tr><td colspan="6">ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ì—°ê²° ì¤‘ì…ë‹ˆë‹¤...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <section>
        <div class="block-header"><span class="block-title">â³ ëŒ€ê¸° í˜„í™©</span></div>
        <div class="queue-container" id="queue-inputs"></div>
        <button class="btn-blue" onclick="assignPlayers()">âš¡ ë¹ˆ ì½”íŠ¸ì— ì¦‰ì‹œ ë°°ì¹˜</button>
    </section>

    <section>
        <div class="block-header"><span class="block-title">ğŸŸï¸ ê²½ê¸° ì½”íŠ¸ í˜„í™©</span></div>
        <div class="court-container" id="court-display"></div>
    </section>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">âš™ï¸ í™˜ê²½ ì„¤ì •</div>
            <div class="form-group">
                <label>ì‚¬ì´íŠ¸ ì œëª©</label>
                <input type="text" id="config-title" placeholder="2026 ê´‘ëª…ë¶ê³  ë°°ë“œë¯¼í„´">
            </div>
            <div class="form-group">
                <label>ì½”íŠ¸ ê°œìˆ˜</label>
                <input type="number" id="config-courts" min="1" max="10">
            </div>
            <button class="btn-blue" onclick="saveSettings()">ì €ì¥í•˜ê³  ëŒì•„ê°€ê¸°</button>
        </div>
    </div>

    <div id="memberModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">ğŸ‘¤ íšŒì› ì¶”ê°€ ë° ìˆ˜ì •</div>
            <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <strong>ìƒˆ íšŒì› ì¶”ê°€</strong>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-top:10px;">
                    <input type="text" id="add-name" placeholder="ì´ë¦„">
                    <select id="add-gender"><option value="ë‚¨">ë‚¨</option><option value="ì—¬">ì—¬</option></select>
                    <input type="text" id="add-level" placeholder="ê¸‰ìˆ˜">
                    <input type="text" id="add-etc" placeholder="ê¸°íƒ€">
                    <button class="btn-green" style="padding: 10px;" onclick="addNewMember()">ì¶”ê°€</button>
                </div>
            </div>
            <div class="table-wrapper member-list-edit">
                <table style="min-width: 100%;">
                    <thead><tr><th>ì´ë¦„</th><th>ì„±ë³„</th><th>ê¸‰ìˆ˜</th><th>ìŠ¹</th><th>íŒ¨</th><th>ê¸°íƒ€</th><th>ì‚­ì œ</th></tr></thead>
                    <tbody id="editMemberTableBody"></tbody>
                </table>
            </div>
            <button class="btn-blue" onclick="closeMemberManager()">ì €ì¥í•˜ê³  ëŒì•„ê°€ê¸°</button>
        </div>
    </div>

    <script>
        // --- 1. Firebase ì„¤ì • ---
        const firebaseConfig = {
            apiKey: "AIzaSyArU7I7QS57fKTI-F0FLlUxG9RufkPllKk",
            authDomain: "gmb-badminton.firebaseapp.com",
            databaseURL: "https://gmb-badminton-default-rtdb.firebaseio.com",
            projectId: "gmb-badminton",
            storageBucket: "gmb-badminton.firebasestorage.app",
            messagingSenderId: "625864594459",
            appId: "1:625864594459:web:5c0df980d2596c728054be"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const memberRef = database.ref('badminton/members');
        const configRef = database.ref('badminton/config');

        let memberList = [];
        let siteConfig = { title: "2026 ê´‘ëª…ë¶ê³  ë°°ë“œë¯¼í„´", courtCount: 5 };

        // --- 2. ë°ì´í„° ì´ˆê¸°í™” ë° ìˆ˜ì‹  ---
        window.onload = function() {
            configRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    siteConfig = data;
                    document.getElementById('site-title').innerText = "ğŸ¸ " + siteConfig.title;
                    initLayout();
                }
            });

            memberRef.on('value', (snapshot) => {
                const data = snapshot.val();
                memberList = data ? Object.values(data) : [];
                renderTable();
            });
        };

        function saveData() {
            const dataToSave = {};
            memberList.forEach(m => {
                if(m.name) dataToSave[m.name.replace(/[.#$[\]]/g, "_")] = m;
            });
            memberRef.set(dataToSave);
        }

        // --- 3. í™˜ê²½ ì„¤ì • ê´€ë ¨ ---
        function openSettings() {
            const pw = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            if (pw === "gmb1234") {
                document.getElementById('config-title').value = siteConfig.title;
                document.getElementById('config-courts').value = siteConfig.courtCount;
                document.getElementById('settingsModal').style.display = 'block';
            } else if (pw !== null) {
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
            }
        }

        function saveSettings() {
            const newTitle = document.getElementById('config-title').value || "2026 ê´‘ëª…ë¶ê³  ë°°ë“œë¯¼í„´";
            const newCount = parseInt(document.getElementById('config-courts').value) || 5;
            configRef.set({ title: newTitle, courtCount: newCount });
            document.getElementById('settingsModal').style.display = 'none';
        }

        // --- 4. íšŒì› ê´€ë¦¬ ê¸°ëŠ¥ ---
        function openMemberManager() {
            renderEditTable();
            document.getElementById('memberModal').style.display = 'block';
        }

        function closeMemberManager() {
            saveData();
            document.getElementById('memberModal').style.display = 'none';
        }

        function renderEditTable() {
            const tbody = document.getElementById('editMemberTableBody');
            tbody.innerHTML = '';
            memberList.forEach((m, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${m.name}</td>
                    <td><input type="text" value="${m.gender}" style="width:40px" onchange="updateMemberField(${idx}, 'gender', this.value)"></td>
                    <td><input type="text" value="${m.level}" style="width:60px" onchange="updateMemberField(${idx}, 'level', this.value)"></td>
                    <td><input type="number" value="${m.wins}" style="width:40px" onchange="updateMemberField(${idx}, 'wins', parseInt(this.value))"></td>
                    <td><input type="number" value="${m.losses}" style="width:40px" onchange="updateMemberField(${idx}, 'losses', parseInt(this.value))"></td>
                    <td><input type="text" value="${m.etc || ''}" onchange="updateMemberField(${idx}, 'etc', this.value)"></td>
                    <td><button onclick="deleteMember(${idx})" style="color:red">X</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateMemberField(idx, field, value) {
            memberList[idx][field] = value;
        }

        function addNewMember() {
            const name = document.getElementById('add-name').value.trim();
            if(!name) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
            if(memberList.some(m => m.name === name)) return alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤.");
            
            memberList.push({
                name: name,
                gender: document.getElementById('add-gender').value,
                level: document.getElementById('add-level').value,
                wins: 0, losses: 0,
                etc: document.getElementById('add-etc').value
            });
            document.getElementById('add-name').value = '';
            renderEditTable();
        }

        function deleteMember(idx) {
            if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                memberList.splice(idx, 1);
                renderEditTable();
            }
        }

        // --- 5. CSV ë¡œë“œ (ì ê²€ ë° ìˆ˜ì • ì™„ë£Œ) ---
        document.getElementById('csvFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                // í•œê¸€ ê¹¨ì§ ë° BOM ë°©ì§€ë¥¼ ìœ„í•œ ì „ì²˜ë¦¬
                const rawContent = e.target.result;
                const content = rawContent.replace(/^\uFEFF/, "").trim(); 
                const rows = content.split(/\r?\n/);
                if (rows.length < 2) return;
                
                // 1í–‰(í—¤ë”) í•­ëª© ë¶„ì„
                const headers = rows[0].split(',').map(h => h.trim());
                const idx = {
                    name: headers.indexOf("ì´ë¦„"),
                    gender: headers.indexOf("ì„±ë³„"),
                    level: headers.indexOf("ê¸‰ìˆ˜"),
                    wins: headers.indexOf("ìŠ¹"),
                    losses: headers.indexOf("íŒ¨"),
                    etc: headers.indexOf("ê¸°íƒ€")
                };

                // í•„ìˆ˜ í•­ëª©ì¸ 'ì´ë¦„'ì´ ì—†ëŠ” ê²½ìš° ê²½ê³ 
                if (idx.name === -1) {
                    alert("CSV íŒŒì¼ì˜ ì²« í–‰ì—ì„œ 'ì´ë¦„' í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (í˜„ì¬ í•­ëª©: " + headers.join(", ") + ")");
                    return;
                }

                let updatedCount = 0;
                let addedCount = 0;

                rows.forEach((row, rowIndex) => {
                    if (rowIndex === 0 || row.trim() === "") return;
                    const cols = row.split(',').map(c => c.trim());
                    const name = cols[idx.name];
                    if(!name) return;

                    const existing = memberList.find(m => m.name === name);
                    if(existing) {
                        if(idx.gender !== -1) existing.gender = cols[idx.gender] || existing.gender;
                        if(idx.level !== -1) existing.level = cols[idx.level] || existing.level;
                        if(idx.wins !== -1) existing.wins = parseInt(cols[idx.wins]) || 0;
                        if(idx.losses !== -1) existing.losses = parseInt(cols[idx.losses]) || 0;
                        if(idx.etc !== -1) existing.etc = cols[idx.etc] || existing.etc;
                        updatedCount++;
                    } else {
                        memberList.push({ 
                            name: name, 
                            gender: idx.gender !== -1 ? cols[idx.gender] : "",
                            level: idx.level !== -1 ? cols[idx.level] : "", 
                            wins: idx.wins !== -1 ? parseInt(cols[idx.wins]) || 0 : 0, 
                            losses: idx.losses !== -1 ? parseInt(cols[idx.losses]) || 0 : 0,
                            etc: idx.etc !== -1 ? cols[idx.etc] : ""
                        });
                        addedCount++;
                    }
                });
                
                saveData(); // Firebase ì„œë²„ ì €ì¥
                alert(`ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ: ì‹ ê·œ ${addedCount}ëª… ì¶”ê°€, ê¸°ì¡´ ${updatedCount}ëª… ì—…ë°ì´íŠ¸ ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                e.target.value = ""; // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
            };
            reader.readAsText(file, 'UTF-8');
        });

        // --- 6. UI ë° ë ˆì´ì•„ì›ƒ ì œì–´ ---
        function renderTable() {
            const tbody = document.getElementById('memberTableBody');
            if(memberList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">ì„œë²„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. CSV ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.</td></tr>';
                return;
            }
            tbody.innerHTML = '';
            memberList.forEach(m => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${m.name}</td><td>${m.gender}</td><td>${m.level}</td><td>${m.wins}</td><td>${m.losses}</td><td>${m.etc || ''}</td>`;
                tbody.appendChild(tr);
            });
        }

        function finishGame(n) {
            const body = document.getElementById(`cb${n}`);
            const finishBtn = document.getElementById(`fb${n}`);
            const winner = prompt("ìŠ¹ë¦¬ íŒ€ì„ ì…ë ¥í•˜ì„¸ìš” (A: ìœ—ì¤„íŒ€, B: ì•„ë«ì¤„íŒ€)");
            if (!winner || !['A', 'a', 'B', 'b'].includes(winner)) return;

            const players = body.dataset.players.split(',');
            const isAWins = winner.toUpperCase() === 'A';
            const winIndices = isAWins ? [0, 1] : [2, 3];
            const loseIndices = isAWins ? [2, 3] : [0, 1];

            winIndices.forEach(idx => { const m = memberList.find(x => x.name === players[idx]); if(m) m.wins++; });
            loseIndices.forEach(idx => { const m = memberList.find(x => x.name === players[idx]); if(m) m.losses++; });

            body.innerHTML = "<span>ëŒ€ê¸° ì¤‘</span>";
            body.classList.add('court-waiting');
            finishBtn.style.display = 'none';
            saveData();
        }

        function assignPlayers() {
            const p = [1, 2, 3, 4].map(j => document.getElementById(`q1-p${j}`).value.trim());
            if (p.filter(x => x).length < 4) { alert("1ìˆœìœ„ ëª…ë‹¨ì„ ëª¨ë‘ ì±„ì›Œì£¼ì„¸ìš”."); return; }

            for (let i = 1; i <= siteConfig.courtCount; i++) {
                const body = document.getElementById(`cb${i}`);
                if (body.classList.contains('court-waiting')) {
                    body.innerHTML = `<div>${p[0]}, ${p[1]}</div><div style="font-size:12px; color:#999;">VS</div><div>${p[2]}, ${p[3]}</div>`;
                    body.classList.remove('court-waiting');
                    body.dataset.players = p.join(',');
                    document.getElementById(`fb${i}`).style.display = 'block';
                    document.getElementById(`c${i}`).classList.add('blinking');
                    setTimeout(() => document.getElementById(`c${i}`).classList.remove('blinking'), 3000);
                    shiftQueue();
                    return;
                }
            }
            alert("ë¹ˆ ì½”íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.");
        }

        function shiftQueue() {
            const count = siteConfig.courtCount;
            for (let i = 1; i < count; i++) {
                for (let j = 1; j <= 4; j++) {
                    document.getElementById(`q${i}-p${j}`).value = document.getElementById(`q${i+1}-p${j}`).value;
                }
            }
            for (let j = 1; j <= 4; j++) document.getElementById(`q${count}-p${j}`).value = "";
        }

        function initLayout() {
            const count = siteConfig.courtCount;
            let qHtml = '';
            for(let i=1; i<=count; i++){
                qHtml += `<div class="queue-box"><div class="queue-header" ${i===1?'style="background:#d63031"':''}>${i}ìˆœìœ„</div><div class="queue-body"><input type="text" id="q${i}-p1" placeholder="ì„ ìˆ˜1"><input type="text" id="q${i}-p2" placeholder="ì„ ìˆ˜2"><hr style="border:0.5px solid #eee;"><input type="text" id="q${i}-p3" placeholder="ì„ ìˆ˜3"><input type="text" id="q${i}-p4" placeholder="ì„ ìˆ˜4"></div></div>`;
            }
            document.getElementById('queue-inputs').innerHTML = qHtml;

            let cHtml = '';
            for(let i=1; i<=count; i++){
                cHtml += `<div class="court-box" id="c${i}"><div class="court-header">${i}ì½”íŠ¸</div><div class="court-body court-waiting" id="cb${i}"><span>ëŒ€ê¸° ì¤‘</span></div><button class="btn-finish" id="fb${i}" onclick="finishGame(${i})" style="display:none;">ê²Œì„ ì¢…ë£Œ</button></div>`;
            }
            document.getElementById('court-display').innerHTML = cHtml;
        }

        function toggleMemberView() {
            const content = document.getElementById('member-content');
            content.style.display = (content.style.display === 'none') ? 'block' : 'none';
        }

        function resetData() {
            if(confirm("ì£¼ì˜! ì„œë²„ì˜ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                memberRef.remove();
            }
        }

        function exportToCSV() {
            if(memberList.length === 0) return;
            let csvContent = "\uFEFFì´ë¦„,ì„±ë³„,ê¸‰ìˆ˜,ìŠ¹,íŒ¨,ê¸°íƒ€\n";
            memberList.forEach(m => { 
                csvContent += `${m.name},${m.gender},${m.level||''},${m.wins},${m.losses},${m.etc||''}\n`; 
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `ë°°ë“œë¯¼í„´_íšŒì›ëª…ë‹¨_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }
    </script>
</body>
</html>
